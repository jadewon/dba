name: Monthly DB Audit

on:
  schedule:
    # 매월 2일 00:00 UTC (한국시간 09:00)
    - cron: '0 0 2 * *'
  workflow_dispatch:
    inputs:
      target_month:
        description: '대상 월 (YYYY-MM), 미입력시 이전 월'
        required: false

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Determine target month
        id: month
        run: |
          if [ -n "${{ github.event.inputs.target_month }}" ]; then
            TARGET_MONTH="${{ github.event.inputs.target_month }}"
          else
            # 이전 달 계산
            TARGET_MONTH=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m 2>/dev/null || date -v-1m +%Y-%m)
          fi

          echo "target_month=$TARGET_MONTH" >> $GITHUB_OUTPUT
          echo "대상 월: $TARGET_MONTH"

      - name: Check changes directory
        run: |
          if [ ! -d "changes" ]; then
            echo "changes 디렉토리가 없습니다"
            exit 1
          fi

          TARGET="${{ steps.month.outputs.target_month }}"
          COUNT=$(ls changes/${TARGET}-*.json 2>/dev/null | wc -l || echo "0")
          echo "발견된 변경 파일: ${COUNT}개"

      - name: Run audit check
        run: |
          node scripts/local/audit_check.js "${{ steps.month.outputs.target_month }}"

      - name: Aggregate changes
        run: |
          node scripts/actions/aggregate_and_call.js "${{ steps.month.outputs.target_month }}"

      - name: Call API
        if: success()
        run: |
          curl -X POST "https://hiworks-production.up.railway.app/hiworks/system-account-review" \
            -H "Content-Type: application/json" \
            -H "x-api-key: 02f671d9d66c4a81f101fbb7740a3555a79c233b3e38b5edca9eb416d9070299" \
            -d @diff_result.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: audit-result-${{ steps.month.outputs.target_month }}
          path: diff_result.json
          retention-days: 90
